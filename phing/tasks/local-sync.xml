<project name="local" default="local:setup">

  <target name="local:drupal:install" description="Installs a specific Drupal site using local drush alias.">
    <phingcall target="setup:drupal:install">
      <property name="drush.alias" value="${drush.aliases.local}" />
    </phingcall>
  </target>

  <target name="local:refresh" description="Refreshes local environment from upstream testing database." depends="setup:build, local:sync, local:update"/>

  <target name="local:setup" description="Install dependencies, builds docroot, installs Drupal; uses local drush alias.">
    <phingcall target="setup">
      <property name="drush.alias" value="${drush.aliases.local}" />
      <param name="environment" value="local"/>
    </phingcall>
  </target>

  <!-- Sync each local multisite from remote aliases. -->
  <target name="local:sync" description="Synchronize each local environment from remote (remote --> local).">
    <yamlKeys file="${blt.config-files.project}" variable="multisite" outputProperty="multisite.names"/>
    <foreach list="${multisite.names}" param="multisite.name" target="local:sync:site"/>
  </target>

  <target name="local:sync:site" description="Synchronize local environment from remote (remote --> local)."
          depends="setup:drupal:settings">
    <property name="site.alias.local" value="${multisite.${multisite.name}.aliases.local}"/>
    <property name="site.alias.remote" value="${multisite.${multisite.name}.aliases.remote}"/>
    <drush command="cc drush" alias="${site.alias.local}"/>
    <drush command="sql-drop" alias="${site.alias.local}"/>
    <drush command="sql-sync" alias="">
      <option name="structure-tables-key">lightweight</option>
      <option name="create-db"/>
      <param>@${site.alias.remote}</param>
      <param>@${site.alias.local}</param>
    </drush>
    <drush command="cache-clear" alias="${site.alias.local}">
      <param>drush</param>
    </drush>
    <drush command="cache-rebuild" alias="${site.alias.local}"/>
  </target>

  <target name="local:update" description="Update current database to reflect the state of the Drupal file system; uses local drush alias.">
    <phingcall target="setup:update">
      <property name="drush.alias" value="${drush.aliases.local}"/>
      <property name="environment" value="local"/>
    </phingcall>
  </target>

</project>
