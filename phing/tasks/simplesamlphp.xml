<project name="simplesamlphp" default="simplesamlphp:init">

  <target name="simplesamlphp:init" description="Initializes SimpleSAMLphp for project.">

    <!-- Adds simplesamlphp_auth as a dependency. -->
    <phingcall target="simplesamlphp:lib:init"/>

    <!-- Copies the configuration templates from the library to a simplesamlphp directory located in the project root. -->
    <phingcall target="simplesamlphp:config:init"/>

    <!-- Sets a value in project.yml to let other targets know simplesamlphp is installed -->
    <echo>Updating project.yml.</echo>
    <exec dir="${repo.root}" command="drupal yaml:update:value project.yml simplesamlphp true" logoutput="true" checkreturn="true" passthru="true" level="info"/>

    <!-- Copies a settings file used by the simplesamlphp_auth modeul to site's settings dir. -->
    <phingcall target="simplesamlphp:settings"/>

    <!-- Creates a symlink from the docroot to the web accessible library dir. -->
    <echo>Creating a symbolic link from ${docroot}/simplesaml to web accessible directory in the simplesamlphp library</echo>
    <symlink target="../vendor/simplesamlphp/simplesamlphp/www/" link="${docroot}/simplesaml" overwrite="true" />

    <!-- Outputs a message to edit .htaccess -->
    <phingcall target="simplesamlphp:htaccess"/>

  </target>

  <target name="simplesamlphp:lib:init" unless="simplesamlphp" hidden="true">
    <echo>Adding SimpleSAMLphp Auth module as a dependency.</echo>
    <exec dir="${repo.root}" command="composer require drupal/simplesamlphp_auth:8.3.x-dev" logoutput="true" checkreturn="true" passthru="true" level="info"/>
  </target>

  <target name="simplesamlphp:config:init" unless="simplesamlphp"  hidden="true">
    <echo>Copying config files to ${repo.root}/simplesamlphp/config.</echo>
    <copy todir="${repo.root}/simplesamlphp/config" file="${repo.root}/vendor/simplesamlphp/simplesamlphp/config-templates/authsources.php" overwrite="false"/>
    <exec dir="${repo.root}/simplesamlphp/config" command="curl https://gist.githubusercontent.com/acquialibrary/8059715/raw/a6dc376bfb5068a2c7fe01be315d13bd47d4c10b/9191_config.php > config.php" passthru="true"/>
    <echo>Copying config files to ${repo.root}/simplesamlphp/metadata.</echo>
    <copy todir="${repo.root}/simplesamlphp/metadata" file="${repo.root}/vendor/simplesamlphp/simplesamlphp/metadata-templates/saml20-idp-remote.php" overwrite="false"/>
  </target>

  <target name="simplesamlphp:settings" hidden="true">
    <echo>Adding a simplesamlphp.settings.php file.</echo>
    <copy file="${phing.dir}/files/simplesamlphp/simplesamlphp.settings.php" tofile="${docroot}/sites/default/settings/simplesamlphp.settings.php" overwrite="false"/>
  </target>

  <!-- Copies customized config files into the library on deployments. -->
  <target name="simplesamlphp:deploy:config" description="Copies config template files to the appropriate place in simplesamlphp library." hidden="true">
    <echo>Copying config files to the appropriate place in simplesamlphp library in the deploy artifact.</echo>
    <copy todir="${repo.root}/deploy/vendor/simplesamlphp/simplesamlphp" overwrite="true">
      <fileset dir="${repo.root}/simplesamlphp/" />
    </copy>
    <copy file="${phing.dir}/files/simplesamlphp/gitignore.txt" tofile="${repo.root}/deploy/vendor/simplesamlphp/simplesamlphp/.gitignore" overwrite="true"/>
  </target>

  <!-- Copies customized config files into the library on builds. -->
  <target name="simplesamlphp:build:config" description="Copies config template files to the appropriate place in simplesamlphp library.">
    <echo>Copying config files to the appropriate place in simplesamlphp library.</echo>
    <copy todir="${repo.root}/vendor/simplesamlphp/simplesamlphp" overwrite="true">
      <fileset dir="${repo.root}/simplesamlphp/" />
    </copy>
    <copy file="${phing.dir}/files/simplesamlphp/gitignore.txt" tofile="${repo.root}/vendor/simplesamlphp/simplesamlphp/.gitignore" overwrite="true"/>
  </target>

  <!-- Simple message to add lines to .htaccess file -->
  <target name="simplesamlphp:htaccess" hidden="true">
    <echo>
      To complete the setup you must manually modify your .htaccess file by adding
      the 2 lines with the + signs in the snippet below.
    </echo>
    <echo>

      # Copy and adapt this rule to directly execute PHP files in contributed or
      # custom modules or to run another PHP application in the same directory.
      RewriteCond %{REQUEST_URI} !/core/modules/statistics/statistics.php$
    + # Allow access to simplesaml paths
    + RewriteCond %{REQUEST_URI} !^/simplesaml
      # Deny access to any other PHP files that do not match the rules above.
      RewriteRule "^.+/.*\.php$" - [F]

    </echo>
  </target>

</project>
