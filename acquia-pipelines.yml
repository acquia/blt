# This is not the acquia-pipelines file that will be used for projects generated via BLT.
# This file will create a sample BLT project against which to test. It uses the same logic as the child project's
# acquia-pipelines.yml file wherever possible.
version: 1.0.0
services:
  - mysql

variables:
  global:
    COMPOSER_BIN: $BUILD_DIR/vendor/bin
    BLT_DIR: $BUILD_DIR
    IS_PULL_REQUEST: true
    PATH: $COMPOSER_BIN:$PATH

events:
  build:
    steps:
        # Install global packages and set global configuration.
        - setup-environment:
            type: script
            script:
              - source $BLT_DIR/scripts/pipelines/setup_environment

        # Install project level packages and set project level configuration.
        - setup-project:
            type: script
            script:
              - source $BLT_DIR/scripts/pipelines/setup_project

        # Execute all testing and validation tasks.
        - run-tests:
            type: script
            script:
              - cat phing/tasks/blt.xml
              # Create a sample, BLT-generated project against which to test.
              - source ${BLT_DIR}/scripts/blt/ci/smoke_tests.sh
              # Create a sample, BLT-generated project against which to test.
              - source ${BLT_DIR}/scripts/blt/ci/create_blt_project.sh
              # Execute tests against sample project.
              - source ${BLT_DIR}/scripts/pipelines/run_tests
              # Make BLT doctor happy.
              - source ${BLT_DIR}/scripts/blt/ci/doctor.sh
              # Modify sample project such that an artifact can be generated from it.
              - source ${BLT_DIR}/scripts/blt/ci/prepare_artifact.sh


        # Generate artifact.
        - build-artifact:
            type: script
            script:
              # Build the artifact.
              - source ${BLT_DIR}/scripts/pipelines/build_artifact
              - source ${BLT_DIR}/scripts/blt/ci/test_artifact.sh
